<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Appspresso를 사용하여 하이브리드앱 개발하기 - 10.Android C2DM 푸시 적용하기</title>
    <meta name="description" content="">

    <meta content="saltfactory's blog" property="og:site_name">
    
    <meta content="Appspresso를 사용하여 하이브리드앱 개발하기 - 10.Android C2DM 푸시 적용하기" property="og:title">
    
    
    <meta content="article" property="og:type">
    
    <!-- 서론

이번 글에서는 Appsresso (앱스프레소)에서 안드로이드 앱에서 설치될 경우 푸시 적용을 어떻게 하는지에 대해 설명한다. Appspresso를 사용하여 하이브리드앱 개발하기 - 9.iOS 푸시 적용하기 글에서 우리는 PDK(Plugins Development Kit)를 이용해서 iOS (iPhone, iPad, iPod touch) 앱에서 푸시를 설정하는 방법을 살펴 보았다. 혹시 PDK을 이용하여 네이티브 코드를 사용하는 방법을 참고 하고 싶으면 Appspresso를 사용하여 하이브리드앱 개발하기 - 5.PDK(Plugin Development Kit)를 이용하여 네이티브 코드 사용 글을 참조하기 바란다.
 -->


    
    
    <meta content="http://blog.saltfactory.net/appspresso/implementing-android-c2dm-in-appspresso.html" property="og:url">
    
    
    <meta content="2012-05-07T00:00:00+09:00" property="article:published_time">
    <meta content="http://blog.saltfactory.net/about/" property="article:author">
    
    <!-- 
    <meta content="/img/logo-high-resolution.png" property="og:image">
     -->
    
    
    <meta content="appspresso" property="article:section">
    
    
    
    
    <meta content="appspresso" property="article:tag">
    
    <meta content="hybrid" property="article:tag">
    
    <meta content="hybridapp" property="article:tag">
    
    <meta content="ios" property="article:tag">
    
    <meta content="android" property="article:tag">
    
    <meta content="javascript" property="article:tag">
    
    <meta content="java" property="article:tag">
    
    <meta content="objective-c" property="article:tag">
    
    <meta content="c2dm" property="article:tag">
    
    



    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://blog.saltfactory.net/appspresso/implementing-android-c2dm-in-appspresso.html">
    <link rel="meta" type="application/rdf+xml" title="FOAF" href="/assets/foaf.rdf" />

    

    
      <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-8647285-2', 'auto');
ga('send', 'pageview');
</script>

    
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">saltfactory's blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
        viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
        <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
        h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
        <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
        h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
        <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
        c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
      </svg>
    </a>
    <div class="trigger">
      <!-- <a class="page-link" href="http://saltfactory.net">saltfactory.net</a> -->
      <!--
      
      <a class="page-link" href="/about/">About</a>
      
      
      
      
      
      
      
      <a class="page-link" href="/categories/">Categories</a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      <a class="page-link" href="/guestbook/">GuestBook</a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <a class="page-link" href="/categories/ruby/">Articles by category: ruby</a>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      -->


      <a class="page-link" href="/about/">About</a>
      <a class="page-link" href="/categories/">Categories</a>
      <a class="page-link" href="/guestbook/">GuestBook</a>
      <a class="page-link" href="http://saltfactory.net">saltfactory.net</a>
    </div>

    </nav>
    <script>
(function() {
  var cx = '014516175331458470005:ze8dwrrwnac';
  var gcse = document.createElement('script');
  gcse.type = 'text/javascript';
  gcse.async = true;
  gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
  '//cse.google.com/cse.js?cx=' + cx;
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(gcse, s);
})();
</script>
<gcse:search></gcse:search>

</div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Appspresso를 사용하여 하이브리드앱 개발하기 - 10.Android C2DM 푸시 적용하기</h1>
    <p class="post-meta">May 7, 2012</p>
  </header>

  <article class="post-content">
    <h2 id="서론">서론</h2>

<p>이번 글에서는 Appsresso (앱스프레소)에서 안드로이드 앱에서 설치될 경우 푸시 적용을 어떻게 하는지에 대해 설명한다. <a href="http://blog.saltfactory.net/134">Appspresso를 사용하여 하이브리드앱 개발하기 - 9.iOS 푸시 적용하기</a> 글에서 우리는 PDK(Plugins Development Kit)를 이용해서 iOS (iPhone, iPad, iPod touch) 앱에서 푸시를 설정하는 방법을 살펴 보았다. 혹시 PDK을 이용하여 네이티브 코드를 사용하는 방법을 참고 하고 싶으면 <a href="http://blog.saltfactory.net/129">Appspresso를 사용하여 하이브리드앱 개발하기 - 5.PDK(Plugin Development Kit)를 이용하여 네이티브 코드 사용</a> 글을 참조하기 바란다.</p>

<!--more-->

<p>Appspresso에서 푸시를 적용하기 위해선 PDK를 이용해서 Appspresso Plugins Project를 생성하여 연결해야한다. 이 과정에 대해서는 이전의 글들을 살펴보면 될 것이다. 이전에 우리는 SaltfactoryPushPlugin이라는 plugin 프로젝트를 만들었고 SaltfactoryPushPlugin_ios 와 SaltfactoryPushPlugin_android 안드로이드 모듈 프로젝트가 만들었다.</p>

<p><img src="http://cfile27.uf.tistory.com/image/1856C4334FA38276283AD8" alt=""></p>

<p>Appspresso에서 Android module project를 생성하면 다음과 같이 에러가 날 것이다.</p>

<p><img src="http://cfile8.uf.tistory.com/image/183051374FA3855321FFAD" alt=""></p>

<p>이 것은 Appspresso에서 안드로이드 모듈을 생성하는 프로젝트만 만들어주고 library path를 자동으로 잡아주지 않기 때문에 발생하는 문제이다. 그래서 JRE와 android.jar 추가한다.</p>

<p><img src="http://cfile8.uf.tistory.com/image/1751D2434FA3861B044FA2" alt=""></p>

<p>이때 주의할 것은 안드로이드에서 C2DM을 사용하기 위해서는 android-8 버전 이후 부터 사용이 가능하기 때문에 이후의 android.jar를 추가한다.</p>

<p><img src="http://cfile5.uf.tistory.com/image/2042CC424FA3868102DAC0" alt=""></p>

<p>이 글 앞에 설명한 <a href="http://blog.saltfactory.net/134">Appspresso를 사용하여 하이브리드앱 개발하기 - 9.iOS 푸시 적용하기</a>과 동일한 과정으로 해보자. iOS에서 마찬가지로 디바이스 토큰을 가져와야하는데, 안드로이드에서는 디바이스토큰 대신에 registration_id라는 용어를 사용한다. 디바이스마다 고유한 아이디를 C2DM 서비스에서 획득해서 푸시를 보낼때 그 아이디를 사용하는 것인데, android는 iOS와 다르게 delegate method로 구현되는 것이 아니라 Services 라는 것을 사용해서 iOS와 동일한 과정으로 registration_id를 획득할 수 있다. (C2DM을 사용하기 위해서 구글에 서비스 등록 신청서를 작성해서 전송해야하는데 그 과정은 생략한다.)</p>

<p>우리는 두가지 클래스를 만들 것이다. 하나는 registration_id를 획득하기 위한 C2DMRegistrationReceiver와 푸시가 안드로이드 디바이스로 왔을때 푸시를 처리할 C2DMReceiver 클래스를 생성한다. net.saltfactory.tutorial 이라는 패키지 안에다 두 클래스를 만들었다.</p>

<p><img src="http://cfile27.uf.tistory.com/image/1177323E4FA388912559EF" alt=""></p>

<p>이제 regsistration_id를 획득하기 위해서 C2DMRegistrationReceiver 클래스를 구현한다. iOS에서 디바이스 토큰을 NSUserDefaults에 저장하듯, android에서는 SharedPreferences에 &quot;registration_id&quot; 라는 키로 저장을 한다.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">saltfactory</span><span class="o">.</span><span class="na">tutorial</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.content.BroadcastReceiver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.SharedPreferences</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.preference.PreferenceManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * User: saltfactory</span>
<span class="cm"> * Date: 11/23/11</span>
<span class="cm"> * Time: 3:06 PM</span>
<span class="cm"> * Email: saltfactory@gmail.com</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">C2DMRegistrationReceiver</span>  <span class="kd">extends</span> <span class="n">BroadcastReceiver</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;Registration Receiver called&quot;</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="s">&quot;com.google.android.c2dm.intent.REGISTRATION&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;Received registration ID&quot;</span><span class="o">);</span>

            <span class="kd">final</span> <span class="n">String</span> <span class="n">registrationId</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&quot;registration_id&quot;</span><span class="o">);</span>

            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;net.saltfactory.tutorial:&quot;</span><span class="o">+</span> <span class="n">registrationId</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">registrationId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">SharedPreferences</span> <span class="n">preference</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                <span class="n">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">preference</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>
                <span class="n">editor</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">&quot;registration_id&quot;</span><span class="o">,</span> <span class="n">registrationId</span><span class="o">);</span>
                <span class="n">editor</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">error</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&quot;error&quot;</span><span class="o">);</span>

                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;dmControl: registrationId = &quot;</span> <span class="o">+</span> <span class="n">registrationId</span><span class="o">+</span> <span class="s">&quot;, error = &quot;</span> <span class="o">+</span> <span class="n">error</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>안드로이드에서는 C2DM을 사용하기 위해서 AndroidManifest.xml를 C2DM을 사용한다고 설정을 해야한다. Appspresso 1.1 버전부터는 각각의 앱 환경 설정을 외부에서 설정할 수 있게 업데이트가 되었는데 AndroidManifest.axml 이라는 파일에서 설정을 추가할 수 있게 되었다.</p>

<p><img src="http://cfile29.uf.tistory.com/image/12505B4B4FA3E72B0C2B62" alt=""></p>

<p>AndroidManifest.axml 파일을 열어서 C2DM을 사용할 수 있게 설정을 추가한다. 기존의 C2DM을 사용했던 개발자나 연구원들은 패키지명 규칙에 대해서 잘 알고 있지만 처음 C2DM을 접하는 분은 꼭 패키지명에 대해서 주의하길 바란다. 그런 의미에서 패키지 명에 대해서 다시 다른 색으로 표시하였다. 이 포스팅의 예제에서 C2DM의 기본 패키지는 net.saltfactory.tutorial이라고 지정하였다.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="na">package=</span><span class="s">&quot;@PACKAGE@&quot;</span>
    <span class="na">android:installLocation=</span><span class="s">&quot;@INSTALL_LOCATION@&quot;</span>
    <span class="na">android:versionCode=</span><span class="s">&quot;@VERSION_CODE@&quot;</span>
    <span class="na">android:versionName=</span><span class="s">&quot;@VERSION_NAME@&quot;</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;application</span>
        <span class="na">android:icon=</span><span class="s">&quot;@drawable/ax_icon&quot;</span>
        <span class="na">android:label=</span><span class="s">&quot;@string/ax_name&quot;</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;activity</span>
            <span class="na">android:name=</span><span class="s">&quot;@ACTIVITY@&quot;</span>
            <span class="na">android:configChanges=</span><span class="s">&quot;orientation|keyboard|keyboardHidden&quot;</span>
            <span class="na">android:screenOrientation=</span><span class="s">&quot;@ACTIVITY_ORIENTATION@&quot;</span>
            <span class="na">android:theme=</span><span class="s">&quot;@ACTIVITY_THEME@&quot;</span> <span class="nt">&gt;</span>

            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>

        <span class="nt">&lt;/activity&gt;</span>

        <span class="c">&lt;!-- If you want to add another android components, please let them be here. --&gt;</span>
        <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;.C2DMRegistrationReceiver&quot;</span>
                  <span class="na">android:permission=</span><span class="s">&quot;com.google.android.c2dm.permission.SEND&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.REGISTRATION&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/receiver&gt;</span>


        <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;.C2DMReceiver&quot;</span>
                  <span class="na">android:permission=</span><span class="s">&quot;com.google.android.c2dm.permission.SEND&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.RECEIVE&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/receiver&gt;</span>
    <span class="nt">&lt;/application&gt;</span>

    <span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">&quot;C2dmReceiver&quot;</span> <span class="na">android:permission=</span><span class="s">&quot;com.google.android.c2dm.permission.SEND&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.RECEIVE&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.REGISTRATION&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
    <span class="nt">&lt;/receiver&gt;</span>

    <span class="nt">&lt;permission</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial.permission.C2D_MESSAGE&quot;</span> <span class="na">android:protectionLevel=</span><span class="s">&quot;signature&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;net.saltfactory.tutorial.permission.C2D_MESSAGE&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.permission.RECEIVE&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>
    @USES_PERMISSION@

    @USES_SDK@

<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<p>이제 C2DM을 등록하고 받기 위해서 설정하는 부분을 마쳤다. 실제 푸시가 왔을 때 디바이스에 어떠한 일을 처리하기 위해서 C2DMReceiver를 구현하도록 하자. iOS는 기본적으로 푸시가 오면 Alert 창이 나타나거나 Push Notification Center에 목록으로 나타나지만, 안드로이드는 푸시가 왔다는 이벤트만 감지하지 다른 모든 것은 직접 구현을 해야한다. 이 포스팅의 예제에서는 Toast 를 하나 띄워서 푸시에서 받는 텍스트를 출력시키도록 한다.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">net</span><span class="o">.</span><span class="na">saltfactory</span><span class="o">.</span><span class="na">tutorial</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.content.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.Toast</span><span class="o">;</span>

<span class="cm">/*</span>
<span class="cm"> * User: saltfactory</span>
<span class="cm"> * Date: 11/23/11</span>
<span class="cm"> * Time: 1:35 PM</span>
<span class="cm"> * Email: saltfactory@gmail.com</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">C2DMReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;Message Receiver called&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">&quot;com.google.android.c2dm.intent.RECEIVE&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="s">&quot;Received message&quot;</span><span class="o">);</span>

            <span class="kd">final</span> <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getStringExtra</span><span class="o">(</span><span class="s">&quot;payload&quot;</span><span class="o">);</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;net.saltfactory.tutorial&quot;</span><span class="o">,</span> <span class="n">payload</span><span class="o">);</span>

            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">payload</span><span class="o">,</span> <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
<p>C2DM을 등록하거나 디바이스에서 푸시가 왔을 때 받는 클래스를 모두 정의하였다. 이제 앱이 실행될 때 registration_id를 획득할 수 있게 설정해줘야한다. iOS용 푸시를 설정할 때 AxPlugin 프로토콜에 UIApplicationDelegate를 MyPlugin 클래스에서 추가한 것을 기억할 것이다. Android에서도 동일하게 MyPlugin 클래스에 iOS와 비슷한 방법으로 등록을 할 것이다. iOS에서는 protocol이라는 것을 사용해서 정의된 delegate 메소드를 사용할 수 있지만 android에는 listener라는 방법을 사용한다. 안드로이드의 MyPlugin 클래스는 AxPlugin 이라는 interrface에 의해 정의된 클래스이다. 그중에서 activate는 iOS의 - activate: 와 동일한 메소드가 존재하고 iOS의 plugin과 마찬가지로 AxRuntimeContext 를 받아서 사용한다. AxRuntimeContext에는 -addActivityListener라는 메소드가 존재하는데 이것은 Android의 Activity의 이벤트를 wrapping하여 핸들링할 수 있게 만든 AcitivityListener를 runtimeContext에 추가할 수 있게 하는 메소드 이다. 아래와 같이 MyPlugin의 activate 메소드 안에서 activityListener를 만들어서 runtimeContext에 addActivityListener로 추가한다. ActivityListener는 Activity의 이벤트를 각각 onActivity이벤트 로 래핑되어져 있다. 그중에서 우리는 activity가 처음 생성될 때 registration_id를 획득하기 원하기 때문에 onActivityCreate 메소드 안에서 registration_id를 획득할 수 있는 코드를 추가한다. 마지막으로 우리는 HTML로 되어진 web에서 registration_id를 가져올 것인데, 이 방법도 iOS에서 javascript에서 call by name으로 획득하는 방법과 동일하게 execute 메소드 안에서 getDeviceToken이라는 이름으로 접근하여 받아오게 할 것이다.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyPlugin</span> <span class="kd">implements</span> <span class="n">AxPlugin</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">AxRuntimeContext</span> <span class="n">runtimeContext</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ActivityListener</span> <span class="n">activityListener</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">activate</span><span class="o">(</span><span class="n">AxRuntimeContext</span> <span class="n">runtimeContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">runtimeContext</span> <span class="o">=</span> <span class="n">runtimeContext</span><span class="o">;</span>

        <span class="c1">// TODO: addActivityListener</span>
        <span class="k">this</span><span class="o">.</span><span class="na">activityListener</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ActivityListener</span><span class="o">(){</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityCreate</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span>
                    <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="n">Intent</span> <span class="n">registrationIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="s">&quot;com.google.android.c2dm.intent.REGISTER&quot;</span><span class="o">);</span>
                <span class="n">registrationIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;app&quot;</span><span class="o">,</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(),</span> <span class="mi">0</span><span class="o">));</span> <span class="c1">// Application ID</span>
                <span class="n">registrationIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="s">&quot;sender&quot;</span><span class="o">,</span> <span class="s">&quot;saltfactory@gmail.com&quot;</span><span class="o">);</span>  <span class="c1">// Sender ID</span>
                <span class="n">activity</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">registrationIntent</span><span class="o">);</span> <span class="c1">//서비스 시작 (Registration ID 발급 받기)</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityDestroy</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityPause</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityRestart</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span>
                    <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">imageReturnedIntent</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityResume</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityStart</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityStop</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onBackPressed</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCreateOptionsMenu</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNewIntent</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onOptionsItemSelected</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span>
                    <span class="n">MenuItem</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onPrepareOptionsMenu</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">Menu</span> <span class="n">menu</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRestoreInstanceState</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span>
                    <span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSaveInstanceState</span><span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">outState</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onWindowFocusChanged</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">hasFocus</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// TODO Auto-generated method stub</span>

            <span class="o">}};</span>
        <span class="k">this</span><span class="o">.</span><span class="na">runtimeContext</span><span class="o">.</span><span class="na">addActivityListener</span><span class="o">(</span><span class="n">activityListener</span><span class="o">);</span>

        <span class="c1">// TODO: addWebViewListener</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deactivate</span><span class="o">(</span><span class="n">AxRuntimeContext</span> <span class="n">runtimeContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">runtimeContext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="c1">// TODO: removeActivityListener</span>
        <span class="k">this</span><span class="o">.</span><span class="na">runtimeContext</span><span class="o">.</span><span class="na">removeActivityListener</span><span class="o">(</span><span class="n">activityListener</span><span class="o">);</span>
        <span class="c1">// TODO: removeWebViewListener</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">AxPluginContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getMethod</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="s">&quot;echo&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getParamAsString</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">context</span><span class="o">.</span><span class="na">sendResult</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="s">&quot;getDeviceToken&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">)){</span>
            <span class="n">SharedPreferences</span> <span class="n">preferences</span> <span class="o">=</span> <span class="n">PreferenceManager</span><span class="o">.</span><span class="na">getDefaultSharedPreferences</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">runtimeContext</span><span class="o">.</span><span class="na">getActivity</span><span class="o">());</span>
            <span class="n">String</span> <span class="n">registeration_id</span> <span class="o">=</span> <span class="n">preferences</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;registration_id&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">context</span><span class="o">.</span><span class="na">sendResult</span><span class="o">(</span><span class="n">registeration_id</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">context</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">AxError</span><span class="o">.</span><span class="na">NOT_AVAILABLE_ERR</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
<p>C2DM에 관한 안드로이드 설정은 모두 끝났다. 저 포스팅에서도 이야기 했지만 Asspresso의 현재 버전은 디바이스 디버깅을 할 수가 없다. 그러한 이유로 이전 포스팅 (iOS 디바이스를 디버깅하는 방법 포함) 에서는 organizer를 이용해서 디바이스 콘솔 로그를 확인하였다. Android SDK를 다운 받으면 Xcode의 organizer와 동일하게 사용할 수 있는 것이 바로 ddms 라는 툴이다. ddms는 Dalvik Debug Monitor 라는 툴로 디바이스의 여러가지 상태를 디버깅 할 수 있다. HTC의 NexusOne의 net.saltfactory.tutorial이라는 예제 앱을 디버깅할 때 다음과 같이 로그를 확인할 수 있다.</p>

<p><img src="http://cfile1.uf.tistory.com/image/157283424FA714EA07F033" alt=""></p>

<p>이렇게 ddms를 켜둔 상태에서 Appspresso에서 Android 디바이스로 빌드와 설치를 진행하면 디바이스 로그를 모니터링 할 수 있다. 우리는 앱이 실행될 때 registration_id를 획득하게 프로그램을 작성하였다. 그리고 registration_id를 획득하면 로깅하도록 했기 때문에 ddms에서 registration_id를 로깅하는 것을 확인할 수 있다.</p>

<p><img src="http://cfile8.uf.tistory.com/image/181470464FA7167E027FCD" alt=""></p>

<p>디바이스에서 획득한 registration_id를 index.html으로 가져오기 위해서 stub 메소드는 구현되어져 있다. iOS 푸시 예제를 만들때 사용한 stub를 그대로 사용하는데 이 때 &quot;getDeviceToken&quot;이라는 이름으로 네이티브 클래스와 통신하게 했었던 것을 기억할 것이다. 혹시 이전 포스팅을 확인하지 못했을 경우를 위해서 코드를 다시 보여주면 SaltfactoryPushPlugin 플러그인 프로젝트에서 axplugin.js에 stub 메소드를 추가한다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/*</span>
<span class="cm"> * JavaScript Stub Appspresso Plugin</span>
<span class="cm"> *</span>
<span class="cm"> * id: net.saltfactory.hybirdtutorial.pushplugin</span>
<span class="cm"> * version: 1.0.0</span>
<span class="cm"> * feature: &lt;feature id=&quot;&quot; category=&quot;Custom&quot; /&gt;</span>
<span class="cm"> */</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">function</span> <span class="nx">echoSync</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">ax</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ax</span><span class="p">.</span><span class="nx">INVALID_VALUES_ERR</span><span class="p">,</span> <span class="s1">&#39;invalid argument!&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">execSync</span><span class="p">(</span><span class="s1">&#39;echo&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">message</span><span class="o">||</span><span class="s1">&#39;&#39;</span> <span class="p">]);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">echoAsync</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nx">ax</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">ax</span><span class="p">.</span><span class="nx">INVALID_VALUES_ERR</span><span class="p">,</span> <span class="s1">&#39;invalid argument!&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">execAsync</span><span class="p">(</span><span class="s1">&#39;echo&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">,</span> <span class="p">[</span> <span class="nx">message</span><span class="o">||</span><span class="s1">&#39;&#39;</span> <span class="p">]);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getDeviceToken</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">execAsync</span><span class="p">(</span><span class="s1">&#39;getDeviceToken&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">myplugin</span> <span class="o">=</span> <span class="nx">ax</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="s1">&#39;net.saltfactory.hybirdtutorial.pushplugin&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s1">&#39;echoSync&#39;</span><span class="o">:</span> <span class="nx">echoSync</span><span class="p">,</span>
        <span class="s1">&#39;echoAsync&#39;</span><span class="o">:</span> <span class="nx">echoAsync</span><span class="p">,</span>
        <span class="s1">&#39;getDeviceToken&#39;</span> <span class="o">:</span> <span class="nx">getDeviceToken</span>
    <span class="p">});</span>
<span class="p">})();</span>
</code></pre></div>
<p>그리고 index.html이 로드될 때 stub를 이용해서 네이티브 코드에서 획득한 registration_id를 이 stub 메소드를 이용해서 가져오게 한다.</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;pragma&quot;</span> <span class="na">content=</span><span class="s">&quot;no-cache&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/appspresso/appspresso.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span>
    <span class="kd">function</span> <span class="nx">errback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">+</span> <span class="s2">&quot; : &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//</span>
    <span class="nx">myplugin</span><span class="p">.</span><span class="nx">getDeviceToken</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ax</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

    <span class="p">},</span> <span class="nx">errback</span><span class="p">);</span>

    <span class="c1">//activate ax.log(), comment out when you release app</span>
    <span class="nx">ax</span><span class="p">.</span><span class="nx">runMode</span> <span class="o">=</span> <span class="nx">ax</span><span class="p">.</span><span class="nx">MODE_DEBUG</span><span class="p">;</span>
    <span class="nx">ax</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">id=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>Hello<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;h3&gt;</span>net.saltfactory.tutorial<span class="nt">&lt;/h3&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<p>이제 Appspresso를 디바이스로 빌드하여 설치하면 Appspresso 콘솔과 ADE (Appspresso Debugging Extension)에서 javascript에서 사용되는 appspresso의 ax.log를 이용하여 확인할 수 있게 된다.</p>

<p><img src="http://cfile25.uf.tistory.com/image/1765AC454FA720B5078259" alt=""></p>

<p><img src="http://cfile29.uf.tistory.com/image/142173434FA7212A210D0C" alt=""></p>

<p>이제 우리는 regisration_id를 획득하는 방법에 대해서 모두 테스트를 완료하였다. 마지막으로 우리는 서버에서 C2DM으로 메세지를 registration_id를 이용해서 디바이스로 푸시를 보내는 것을 테스트할 것이다. 테스트를 위해서 ruby gem을 이용해서 c2dm을 사용하였지만 다른 c2dm 라이브러리를 이용해서 java나 python으로 전송해도 무관하다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">gem install c2dm
</code></pre></div>
<p>푸시 전송 코드는 이전에 iOS에서 사용하던 ruby 파일에 c2dm을 추가해서 사용했다.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># encoding: UTF-8</span>
<span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;apns&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;c2dm&#39;</span>

<span class="c1"># APNS.host = &#39;gateway.sandbox.push.apple.com&#39;</span>
<span class="c1"># APNS.pem  = &#39;development_cert.pem&#39;</span>
<span class="c1"># APNS.port = 2195</span>
<span class="c1">#</span>
<span class="c1"># device_token = &#39;488fca..51ea&#39; # 아이폰 디바이스 토큰</span>
<span class="c1"># APNS.send_notification(device_token, :alert =&gt; &#39;Appspresso Push Test&#39;, :badge =&gt; 1, :sound =&gt; &#39;default&#39;)</span>

<span class="no">C2DM</span><span class="o">.</span><span class="n">authenticate!</span><span class="p">(</span><span class="s2">&quot;안드로이드 개발자 메일&quot;</span><span class="p">,</span> <span class="s2">&quot;안드로이드 개발자 메일 비밀번호&quot;</span><span class="p">,</span> <span class="s2">&quot;SaltfactoryTutorial-1.0&quot;</span><span class="p">)</span>
<span class="n">c2dm</span> <span class="o">=</span> <span class="no">C2DM</span><span class="o">.</span><span class="n">new</span>

<span class="n">notification</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">:registration_id</span> <span class="o">=&gt;</span> <span class="s2">&quot;APA91b...._qYmU&quot;</span><span class="p">,</span> <span class="c1"># 안드로이드 registration_id</span>
  <span class="ss">:data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:payload</span> <span class="o">=&gt;</span> <span class="s2">&quot;Hello, Appspresso Notification&quot;</span>
  <span class="p">},</span>
  <span class="ss">:collapse_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;SFM12&quot;</span> <span class="c1">#optional</span>
<span class="p">}</span>

<span class="n">c2dm</span><span class="o">.</span><span class="n">send_notification</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>
</code></pre></div>
<p>이렇게 서버에서 전송하게 되면 Android 네이티브 플러그인 코드에서 추가한 C2DMReciver에서 푸시를 받게 되는데 ddms를 확인해서 푸시자 제대로 전송되었는지 확인해보자.</p>

<p><img src="http://cfile25.uf.tistory.com/image/200AEF3D4FA724451F2467" alt=""></p>

<p>서버에서 registration_id를 가지고 C2DM을 이용해서 보낸 푸시가 디바이스에 정상적으로 도착한 것을 확인할 수 있다. 그리고 우리는 예제에서 푸시가 전송되면 Toast를 나타나게 코드를 추가했기 때문에 디바이스 화면에서 Toast가 나타나는 것을 확인할 수 있다.</p>

<p><img src="http://cfile23.uf.tistory.com/image/1413C7424FA724B4299863" alt=""></p>

<h2 id="결론">결론</h2>

<p>Appspresso에서 안드로이드 C2DM을 이용해서 푸시를 적용하는 방법에 대해서 포스팅을 했었다. iOS와 마찬가지로 개발자로 Google에 푸시 서비스를 하기위해서 C2DM 양식을 작성하는 방법은 생략했다.</p>

<p>Appsrpesso에서는 네이티븡 앱과 동일하게 푸시 서비스를 지원한다. iOS 푸시 적용 방법과 Android 푸시 적용방법에 대해서 2가지 포스팅을 걸쳐 설명했지만 잘 살펴보면 네이티브 코드만 다를 뿐 index.html에서 axplugin.js에서 디바이스 코드를 가져오기 위한 stub는 동일하게 사용한다는 것을 확인할 수 있을 것이다. 푸시는 디바이스의 독립적인 방법으로 구현할 수 밖에 없기 때문에 PDK (Plugin Development Kit)으로 Appspresso 플러그인 프로젝트로 추가해서 사용해야한다. 이 때 방법은 AxPlugin을 따르는 interface(안드로이드)와 protocol(아이폰) 처럼 ActivityListener(안드로이드)와 UIApplication(아이폰)을 추가하여 구현한다. 네이티브 코드에서 획득한 디바이스 토큰은 인터페이스와 axplugin.js 에 등록된 stub 메소드를 이용해서 가져올 수 있다.</p>

<p>이제 앱스프레소를 이용해서 푸시 기능을 모두 구현할 수 있게 되었다. 디바이스의 센서를 제외하고 일반적인 앱 서비스를 개발하는데 모두 10가지 Appspresso에 대한 포스팅을 연재하였다. 아직 UI framework에 관한 이야기는 추가하지 않았지만 부록으로 UI framework에 대한 포스팅을 추가할 예정이다. 이 글을 포스팅하는 개발 연구원인 본인은 조그만 부설 연구소에서 혼자 아이폰과 안드로이드 폰 앱을 개발하고 있는데, 개발 비용과 유지보수 비용이 혼자서는 감당하기 힘들어서 하이브리드 앱에 대한 도입을 검토하는 과정에서 앱스프레소와 PhoneGap을 비교하기 하기 위한 글로 하이브리드 앱 개발에 관한 내용을 연재 중이다. 추가적인 질문은  아래의 트위터나 페이스북(댓글, wall)로 질문하면 연구하면서 겪게되는 문제 해결 방법을 같이 나눌 수 있을 것이라 생각된다. 본 연구원은 처음부터 앱 개발자가 아니고 데이터베이스 연구실에서 서버와 데이터베이스를 연구하는 연구원에서 출발 했기 때문에 소프트웨어 개발자보다 코드가 잘 못되거나 성능에 대해서 좋지 못한 코드를 예제로 만들 가능성이 높다. 이 점에 대해서는 양해 바라며, 본 연구원이 연구하면서 알게된 방법을 같이 공유하고자 포스팅을 작성한다는 것을 알아주길 바란다.</p>

<h2 id="연구원-소개">연구원 소개</h2>

<ul>
<li>작성자 : <a href="http://about.me/saltfactory">송성광</a> 개발 연구원</li>
<li>블로그 : <a href="http://blog.saltfactory.net">http://blog.saltfactory.net</a></li>
<li>이메일 : <a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
<li>트위터 : <a href="https://twitter.com/saltfactory">@saltfactory</a></li>
<li>페이스북 : <a href="https://facebook.com/salthub">https://facebook.com/salthub</a></li>
<li>연구소 : <a href="http://www.hibrain.net">하이브레인넷</a> 부설연구소</li>
<li>연구실 : <a href="http://dblab.changwon.ac.kr">창원대학교 데이터베이스 연구실</a></li>
</ul>

  </article>

  <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_sharing_toolbox"></div>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-55706d7f707f75ff" async="async"></script>



<!-- <div class='shareaholic-canvas' data-app='share_buttons' data-app-id=''></div>
<script type="text/javascript">
//<![CDATA[
  (function() {
    var shr = document.createElement('script');
    shr.setAttribute('data-cfasync', 'false');
    shr.src = '//dsms0mj1bbhn4.cloudfront.net/assets/pub/shareaholic.js';
    shr.type = 'text/javascript'; shr.async = 'true';
    shr.onload = shr.onreadystatechange = function() {
      var rs = this.readyState;
      if (rs && rs != 'complete' && rs != 'loaded') return;
      var site_id = 'fd3b2a079d78a86b57bffbfc4e3ee42d';
      try { Shareaholic.init(site_id); } catch (e) {}
    };
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(shr, s);
  })();
//]]>
</script> -->

  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    
      var disqus_shortname = 'saltfactoryblog';
    
    // 
    

    
      var disqus_identifier = 'http://blog.saltfactory.net/135';
    

    
      var disqus_url = 'http://blog.saltfactory.net/appspresso/implementing-android-c2dm-in-appspresso.html';
    


    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  



</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">saltfactory's blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <!-- <li>saltfactory's blog</li> -->
          <li><img class="profile" src="/assets/images/profile.png"/></li>
          <li><a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
          <li><a href="http://saltfactory.net">saltfactory.net</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/saltfactory">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">saltfactory</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/saltfactory">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">@saltfactory</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://facebook.com/salthub">
              <span class="icon icon--facebook">
                <!-- <svg class="facebook-icon-svg" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <path d="M0.112290344,30 C0.112290344,13.4314567 13.3426506,0 29.663129,0 C45.9836073,0 59.2139676,13.4314567 59.2139676,30 C59.2139676,46.5685433 45.9836073,60 29.663129,60 C13.3426506,60 0.112290344,46.5685433 0.112290344,30 Z M0.112290344,30" fill="#C2C2C2" sketch:type="MSShapeGroup"></path>
	<path d="M32.1341457,46.3196729 L32.1341457,29.9980891 L36.5657565,29.9980891 L37.1530406,24.3735809 L32.1341457,24.3735809 L32.141675,21.5584604 C32.141675,20.091502 32.2787707,19.3054722 34.351206,19.3054722 L37.1216686,19.3054722 L37.1216686,13.6803271 L32.6894304,13.6803271 C27.3655995,13.6803271 25.491749,16.4088187 25.491749,20.9972835 L25.491749,24.3742179 L22.1732173,24.3742179 L22.1732173,29.998726 L25.491749,29.998726 L25.491749,46.3196729 L32.1341457,46.3196729 Z M32.1341457,46.3196729" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
</svg>
 -->
                <svg viewBox="0 0 16 28">
                  <path id="logo" d="M14.984 0.187v4.125h-2.453q-1.344 0-1.813 0.562t-0.469 1.687v2.953h4.578l-0.609 4.625h-3.969v11.859h-4.781v-11.859h-3.984v-4.625h3.984v-3.406q0-2.906 1.625-4.508t4.328-1.602q2.297 0 3.563 0.187z"></path>
                </svg>
              </span>
              <span class="username">salthub</span>
            </a>
          </li>

        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
