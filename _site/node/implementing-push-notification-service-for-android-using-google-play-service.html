<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Node.js와 Google Play Service를 이용하여 안드로이드 푸시서비스 구현하기(GCM)</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">
    <link rel="canonical" href="/series/node/implementing-push-notification-service-for-android-using-google-play-service.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/series/assets/css/main.css">
    <!-- <link rel='stylesheet' type='text/css' href='/assets/css/main.css' /> -->

    
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/series/">saltfactory's series</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="page-link" href="/">saltfactory.net</a>
        <a class="page-link" href="/guestbook">Guestbook</a>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Node.js와 Google Play Service를 이용하여 안드로이드 푸시서비스 구현하기(GCM)</h1>
    <p class="meta">Jan 16, 2014</p>
  </header>

  <article class="post-content">
  <h2 id="서론">서론</h2>

<p>번 사내 프로젝트는 아이폰, 안드로이드 푸시 프로바이더를 springframework에서 Node.js로 마이그레이션하는 작업이 진행되었다. 첫번째 포스팅으로 &quot;Node.js로 푸시서비스 구현하기 1. 아이폰(iOS) 푸시서버 구현하기&quot;에서는 node-apn을 이용해서 아이폰 푸시 프로바이더를 구현한 간단한 예제를 소개하였고, 이번 포스팅에서는 node-gcm을 이용해서 안드로이드 푸시 프로바이더를 구현하는 방법을 소개하고자 한다.</p>

<p>우리는 기존에 C2DM(<a href="https://developers.google.com/android/c2dm/?csw=1)%EC%9D%84">https://developers.google.com/android/c2dm/?csw=1)을</a> 사용해서 안드로이드 푸시를 구현했었다. 그러나 링크를 보면 알겠지만 C2DM은 2012년 6월 26일부터 더이상 업데이트를 지원하고 있지않다. 그럼 안드로이드 푸시는 어떻게 구현할 수 있는가? 구글에서는 푸시서비스를 위해서 GCM(Google Cloude Messaging) <a href="http://developer.android.com/google/gcm/index.html">http://developer.android.com/google/gcm/index.html</a> 을 제공하고 있다.</p>

<!--more-->

<h3 id="gcm-프로젝트-등록">GCM 프로젝트 등록</h3>

<p>우선 GCM을 사용하기 위해서는 GCM에 프로젝트를 등록하고 API를 획득해서 사용해야한다. GCM에 프로젝트를 등록하기 위해서는 <a href="https://cloud.google.com/console">Google Developers Console</a>을 연다.</p>

<p>CREATE PROJECT 를 눌러서 안드로이드 푸시 프로젝트를 생성한다.</p>

<p><img src="http://cfile29.uf.tistory.com/image/211A0F4452D7630B23CE46" alt=""></p>

<p><img src="http://cfile10.uf.tistory.com/image/2419944B52D76367276FB5" alt=""></p>

<p>프로젝트를 생성하면 고유 <strong>Project ID</strong>를 입력하고(Project ID는 고유한 값으로 직접 등록할 수 있다.) <strong>Project Number</strong>를 획득한다.</p>

<h3 id="google-cloud-messaging-for-android-활성화">Google Cloud Messaging for Android 활성화</h3>

<p>다음은 APIs &amp; Auth 메뉴를 선택한다. 기본적으로 Google Cloud 서비스 API가 활성화 되어 있는데 GCM을 사용할 때는 필요없기 때문에 모두 비활성화 시킨다. 우리가 필요한 것은 <strong>Google Cloud Messaging for Android API</strong> 이기 때문에 이 항목을 찾아서 활성화 시킨다.</p>

<p><img src="http://cfile29.uf.tistory.com/image/25412F3752D7645E1FE70F" alt=""></p>

<h2 id="api-access-key-생성">API Access Key 생성</h2>

<p>다음은 <strong>Credentials</strong> 메뉴를 선택해서 API access key를 생성한다. <strong>CREATE NEW KEY</strong> 를 선택하면 여러가지 환경에 사용할 key를 만들 수 있는데, 우선 안드로이드 디바이스에서 API access key를 생성해야하기 대문에 <strong>Android Key</strong>를 선택한다.</p>

<p><img src="http://cfile21.uf.tistory.com/image/26274E4C52D7656031E4AF" alt=""></p>

<p><img src="http://cfile26.uf.tistory.com/image/233EB63552D76572062514" alt=""></p>

<p><img src="http://cfile21.uf.tistory.com/image/2402984452D765E40612DB" alt=""></p>

<p>이렇게 등록한 Android API access key는 안드로이드 디바이스에서 GCM을 이용해서 푸시를 받을 수 있는 <strong>registration_id</strong> 값을 획득하는데 사용된다. 아이폰에서는 device token과 같은 개념이 registration_id 이다. 다음은 안드로이드에 registration_id를 획득하는 라이브러리를 추가하고 코드를 작성한다.</p>

<h3 id="gcm-예제-코드-다운로드">GCM 예제 코드 다운로드</h3>

<p>구글에서는 GCM에 관련된 클라이언트 코드를 이미 제공하고 있으니 그 코드를 사용하기로 하자.
<a href="https://code.google.com/p/gcm/">https://code.google.com/p/gcm/</a></p>

<p>구글도 이젠 소스코드를 git로 관리하고 있다. GCM에 관련된 코드를 git를 사용해서 clone을 할 수 있다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">git clone https://code.google.com/p/gcm/
</code></pre></div>
<p><img src="http://cfile2.uf.tistory.com/image/22635C4152D7680008EC12" alt=""></p>

<h3 id="google-play-service-sdk-다운로드">Google Play Service SDK 다운로드</h3>

<p>인터넷에서 GCM 구현에 관련된 글들을 찾아보면 대부분 gcm.jar를 사용하는데 gcm.jar 역시 deprecate 되었다. 그래서 위에서 다운받은 gcm-client-deprecated를 살펴보면 dist 디렉토리 안에 gcm.jar가 포함되어 있는 것을 확인할 수 있다. 하지만 Google에서는 Cloud Messaging Service는 모두 <strong>Google Play Service</strong> 로 통합되었기 때문에 gcm.jar를 사용하는 포스팅을 참조하기 보다는 Google Play Service SDK를 사용한 예제를 참조하는것이 좋다. Google Play Service SDK는 기본적으로 android SDK를 다운 받는다고 설치되는 것이 아니라 extra 로 따로 다운 받아야 한다. android SDK Manager를 열어서 Google Play Service SDK를 다운로드한다.</p>

<p><img src="http://cfile3.uf.tistory.com/image/2367CE3952D7703C1FEF61" alt=""></p>

<p>이렇게 다운받은 파일은 <code>android-sdk-mac/sdk/extras/google/google_play_services/libproject/google-play-services_lib/libs</code> 라는 디렉토리 안에 존재하게 된다.</p>

<p><img src="http://cfile28.uf.tistory.com/image/226E483852D770851AD84C" alt=""></p>

<h3 id="안드로이드-프로젝트-생성">안드로이드 프로젝트 생성</h3>

<p>이제 안드로이드 프로젝트를 생성해서 GCM 획득하는 코드를 추가할 것이다. 이름은 sf-push-demo 라고 만들었다. 안드로이드 개발은 여러가지 IDE로 개발할 수 있으니 보통 eclipse로 한다. 우리는 연구소에서 IntelliJ를 Java IDE를 사용하고 있기 때문에 IntelliJ 환경으로 설명하도록 하겠다.</p>

<p><img src="http://cfile22.uf.tistory.com/image/2510DE3452D769FF319CB0" alt=""></p>

<p><img src="http://cfile27.uf.tistory.com/image/2140E33A52D76A1D184A4A" alt=""></p>

<p>프로젝트 이름은 sf-push-demo 라고 하였고, 패키지이름은 net.saltfactory.tutorial.sfpushdemo로 지정하였다.</p>

<h3 id="google-play-service-sdk-라이브러리-복사">Google Play Service SDK 라이브러리 복사</h3>

<p>그리고 앞에서 다운받은 Google Play SDK를 프로젝트 디렉토리의 libs 안으로 복사한다.</p>

<p><img src="http://cfile6.uf.tistory.com/image/241F7D4652D770D505D1E3" alt=""></p>

<h3 id="google-play-service-version.xml-파일-복사">Google Play Service version.xml 파일 복사</h3>

<p>Google Play Service를 사용하기 위해서는 <code>AndroidManifest.xml</code> 파일 안에 <code>&lt;application&gt;</code>태그 안에 <code>&lt;meta-data&gt;</code> 값으로 Google Play Service 버전 정보를 넣어줘야하는데 이 정보는 <code>android-sdk-mac/sdk/extras/google_play_services/libproject/google-paly-services_lib/res/values/version.xml</code> 에 존재한다. 이 파일을 복사해서 새로 생성한 프로젝트의 <code>res/values/</code> 디렉토리 안에 추가한다.</p>

<p><img src="http://cfile24.uf.tistory.com/image/253A494C52D779FA2D4057" alt=""></p>

<h3 id="android-support-라이브러리-추가">Android Support 라이브러리 추가</h3>

<p>안드로이드에서는 다양한 sdk 버전을 커버하기 위해서 android에서도 확장 라이브러리를 가지고 있는데 GCM 구현에서는 android v4 확장 라이브리가 필요하다. 이것은 <code>android-sdk-mac/sdk/extras/android/support/v4/android-support-v4.jar</code> 에 존재하는데 이것도 libs 디렉토리에 복사해서 넣는다.</p>

<p><img src="http://cfile25.uf.tistory.com/image/2622E53452D772BA314F4D" alt=""></p>

<h3 id="예제-resources-파일-추가">예제 Resources 파일 추가</h3>

<p>그리고 앞에서 clone 받은 gcm-client 디렉토리에서 resources들을 복사한다.</p>

<p><img src="http://cfile3.uf.tistory.com/image/2532CB3B52D772EC1D6ED5" alt=""></p>

<h3 id="gcm-클래스-추가">GCM 클래스 추가</h3>

<p>이젠 GCM을 사용할 준비를 마쳤으니 코드를 추가하자. gcm-client 안에 있는 소스 중에서 <code>src/com/google/android/gcm/demo/app/</code> 디렉토리 안에서 <code>GcmBroadcastReceiver.java</code>와 <code>GcmIntentService.java</code>를 복사해서 프로젝트에 생성된 패키지 안에다 넣는다.</p>

<p><img src="http://cfile21.uf.tistory.com/image/2260443352D773850AC639" alt=""></p>

<h4 id="gcmintentservice-파일-수정">GcmIntentService 파일 수정</h4>

<p>그러면 다음과 같이 GcmIntentService 파일에 에러가 발생하는데 예제로 사용된 gcm-client에서 푸시가 도착하면 DemoActivity를 열려고해서 그런것이다. 이것을 우리가 예제로 생성한 MyActivity가 열리도록 수정을 한다.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Put the message into a notification and post it.</span>
    <span class="c1">// This is just one simple example of what you might choose to do with</span>
    <span class="c1">// a GCM message.</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendNotification</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mNotificationManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">NotificationManager</span><span class="o">)</span>
                <span class="k">this</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">);</span>

        <span class="n">PendingIntent</span> <span class="n">contentIntent</span> <span class="o">=</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">MyActivity</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>

        <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">Builder</span> <span class="n">mBuilder</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setSmallIcon</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_stat_gcm</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setContentTitle</span><span class="o">(</span><span class="s">&quot;GCM Notification&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setStyle</span><span class="o">(</span><span class="k">new</span> <span class="n">NotificationCompat</span><span class="o">.</span><span class="na">BigTextStyle</span><span class="o">()</span>
        <span class="o">.</span><span class="na">bigText</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span>
        <span class="o">.</span><span class="na">setContentText</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>

        <span class="n">mBuilder</span><span class="o">.</span><span class="na">setContentIntent</span><span class="o">(</span><span class="n">contentIntent</span><span class="o">);</span>
        <span class="n">mNotificationManager</span><span class="o">.</span><span class="na">notify</span><span class="o">(</span><span class="n">NOTIFICATION_ID</span><span class="o">,</span> <span class="n">mBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></div>
<h3 id="androidmanifest.xml-파일-수정">AndroidManifest.xml 파일 수정</h3>

<p>다음은 안드로이드에 GCM을 사용할 수 있는 설정을 해야하기 때문에 <code>AndroidManifest.xml</code>을 열어서 다음과 같이 수정한다.</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
          <span class="na">package=</span><span class="s">&quot;com.example.sfpushdemo&quot;</span>
          <span class="na">android:versionCode=</span><span class="s">&quot;1&quot;</span>
          <span class="na">android:versionName=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--&lt;uses-sdk android:minSdkVersion=&quot;19&quot;/&gt;--&gt;</span>
    <span class="c">&lt;!-- GCM requires Android SDK version 2.2 (API level 8) or above. --&gt;</span>
    <span class="c">&lt;!-- The targetSdkVersion is optional, but it&#39;s always a good practice</span>
<span class="c">         to target higher versions. --&gt;</span>
    <span class="nt">&lt;uses-sdk</span> <span class="na">android:minSdkVersion=</span><span class="s">&quot;8&quot;</span> <span class="na">android:targetSdkVersion=</span><span class="s">&quot;16&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- GCM connects to Google Services. --&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.INTERNET&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- GCM requires a Google account. --&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.GET_ACCOUNTS&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Keeps the processor from sleeping when a message is received. --&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">     Creates a custom permission so only this app can receive its messages.</span>

<span class="c">     NOTE: the permission *must* be called PACKAGE.permission.C2D_MESSAGE,</span>
<span class="c">           where PACKAGE is the application&#39;s package name.</span>
<span class="c">    --&gt;</span>
    <span class="nt">&lt;permission</span>
            <span class="na">android:name=</span><span class="s">&quot;com.google.android.gcm.demo.app.permission.C2D_MESSAGE&quot;</span>
            <span class="na">android:protectionLevel=</span><span class="s">&quot;signature&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;uses-permission</span>
            <span class="na">android:name=</span><span class="s">&quot;com.google.android.gcm.demo.app.permission.C2D_MESSAGE&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- This app has permission to register and receive data message. --&gt;</span>
    <span class="nt">&lt;uses-permission</span>
            <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.permission.RECEIVE&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;application</span> <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span> <span class="na">android:icon=</span><span class="s">&quot;@drawable/ic_launcher&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta-data</span>
                <span class="na">android:name=</span><span class="s">&quot;com.google.android.gms.version&quot;</span>
                <span class="na">android:value=</span><span class="s">&quot;@integer/google_play_services_version&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">&quot;MyActivity&quot;</span>
                  <span class="na">android:label=</span><span class="s">&quot;@string/app_name&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.action.MAIN&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;android.intent.category.LAUNCHER&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/activity&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">          BroadcastReceiver that will receive intents from GCM</span>
<span class="c">          services and handle them to the custom IntentService.</span>

<span class="c">          The com.google.android.c2dm.permission.SEND permission is necessary</span>
<span class="c">          so only GCM services can send data messages for the app.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;receiver</span>
                <span class="na">android:name=</span><span class="s">&quot;.GcmBroadcastReceiver&quot;</span>
                <span class="na">android:permission=</span><span class="s">&quot;com.google.android.c2dm.permission.SEND&quot;</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="c">&lt;!-- Receives the actual messages. --&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.RECEIVE&quot;</span> <span class="nt">/&gt;</span>
                <span class="c">&lt;!-- Receives the registration id. --&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.c2dm.intent.REGISTRATION&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">&quot;com.google.android.gcm.demo.app&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/receiver&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">          Application-specific subclass of GCMBaseIntentService that will</span>
<span class="c">          handle received messages.</span>

<span class="c">          By default, it must be named .GCMIntentService, unless the</span>
<span class="c">          application uses a custom BroadcastReceiver that redefines its name.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">&quot;.GcmIntentService&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div>
<p>긴 작업이였지만 위의 순서대로 진행하면 오류없이 안드로이드 디바이스로 빌드가 될 것이다. 그리고 빌드가 성공하면 TextView에 안드로이드 디바이스 정보가 나오는 것을 확인할 수 있다.</p>

<p><img src="http://cfile25.uf.tistory.com/image/2140593952D77BF7129220" alt=""></p>

<p>이렇게 획득한 <strong>registration_id</strong> 는 푸시 프로바이더에서 푸시를 발송할 때 사용된다.</p>

<h2 id="node-gcm-설치">node-gcm 설치</h2>

<p>이제 안드이드 디바이스는 푸시를 받을 준비를 모두 마쳤다. 이젠 안드로이드 디바이스로 푸시를 발송하는 푸시 프로바이더를 구현할 것이다. 우리는 Node.js를  이용해서 푸시 프로바이더 구현하기로 했다. node-gcm은 이 과정을 매우 간단하게 만들어준다. 먼저 node-gcm을 설치하자.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">npm install node-gcm
</code></pre></div>
<p><img src="http://cfile26.uf.tistory.com/image/266F7C3B52D77D030FFE77" alt=""></p>

<h2 id="push-provider-gcm-server-access-key-생성">Push Provider GCM Server Access Key 생성</h2>

<p>우리는 앞에서 안드로이드의 registration_id를 획득하기 위해서 엑세스키를 만드는 과정을 한번 진행했었다. 이제 동일한 작업으로 server key를 생성한다.</p>

<p><img src="http://cfile9.uf.tistory.com/image/2276B54952D77DCF2B3C35" alt=""></p>

<p>서버는 IPs 접근을 제한하는 항목이 보일것이다. 이제 푸시 프로바이더의 access key를 구했으니 푸시 프로바이더 코드를 작성하자.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">gcm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-gcm&#39;</span><span class="p">);</span>

<span class="c1">// create a message with default values</span>
<span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gcm</span><span class="p">.</span><span class="nx">Message</span><span class="p">();</span>

<span class="c1">// or with object values</span>
<span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gcm</span><span class="p">.</span><span class="nx">Message</span><span class="p">({</span>
    <span class="nx">collapseKey</span><span class="o">:</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span>
    <span class="nx">delayWhileIdle</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">timeToLive</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">key1</span><span class="o">:</span> <span class="s1">&#39;안녕하세요.&#39;</span><span class="p">,</span>
        <span class="nx">key2</span><span class="o">:</span> <span class="s1">&#39;saltfactory push demo&#39;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">server_access_key</span> <span class="o">=</span> <span class="s1">&#39;푸시 프로바이더 서버 access key 값&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">sender</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">gcm</span><span class="p">.</span><span class="nx">Sender</span><span class="p">(</span><span class="nx">server_access_key</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">registrationIds</span> <span class="o">=</span> <span class="p">[];</span>

<span class="kd">var</span> <span class="nx">registration_id</span> <span class="o">=</span> <span class="s1">&#39;안드로이드 registration_id 값&#39;</span><span class="p">;</span>
<span class="c1">// At least one required</span>
<span class="nx">registrationIds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">registration_id</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Params: message-literal, registrationIds-array, No. of retries, callback-function</span>
<span class="cm"> **/</span>
<span class="nx">sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">registrationIds</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>이제 이 파일을 실행한다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">node sf-push-provider.js
</code></pre></div>
<p>잠시 후 안드로이드 디바이스로 GCM으로 메세지가 전송된 것을 확인할 수 있다. (아래와 같이 출력하기 위해서는 안드로이드의 GCM 코드에 약간의 변경을 가해야한다. 구글에서 제공하는 기본 코드는 푸시 프로바이더의 payload로 전송한 key값을 출력하는 것이 아니라 object자체를 출력하게 되어 있다.) 이 포스팅에 진행된 모든 소스코드는 github를 통해서 공개하고 있으니 참조하기 바란다.</p>

<p><img src="http://cfile23.uf.tistory.com/image/2309864152D78237332EB1" alt=""></p>

<h2 id="결론">결론</h2>

<p>안드로이드 푸시는 아이폰의 푸시보다 복잡하게 구현한다. 더구나 이전에 C2DM과 gcm.jar를 이용하는 방법의 포스팅이 많아서 대부분 deprecate 되어 있는 자료로 푸시를 구현하고 있어서 Google Play Service를 이용하여 푸시를 전송하는 방법을 소개했다. 더구나 푸시의 핵심은 바로 Push Provider를 구축하는 것인데 기존의 구글에서 제공하는 GCM-Server를 열어보면 Java로 매우 긴 코드로 복잡하게 되어 있다. 우리는 사내 프로젝트로 Springframework를 도입했는데, 단순히 푸시 서버를 구현하는데 너무 많은 자원을 사용하고 복잡도가 높았기 때문에 이번에 Node.js로 마이그레이션을 진행하였다. 이에 우리 연구소에서 진행한 자료를 보다 간단하게 만들어서 공개하기로 결정했으며, 안드로이드 및 아이폰 푸시 서비스를 구축하는 개인 개발자와 소규모 중소기업에 조금이라도 도움이 되길 바란다.</p>

<h2 id="소스코드">소스코드</h2>

<ul>
<li><a href="https://github.com/saltfactory/saltfactory-android-tutorial/tree/sf-push-demo">https://github.com/saltfactory/saltfactory-android-tutorial/tree/sf-push-demo</a></li>
</ul>

<h2 id="참고">참고</h2>

<ol>
<li><a href="http://developer.android.com/google/gcm/index.html">http://developer.android.com/google/gcm/index.html</a></li>
<li><a href="http://developer.android.com/google/gcm/gs.html">http://developer.android.com/google/gcm/gs.html</a></li>
<li><a href="https://github.com/ToothlessGear/node-gcm">https://github.com/ToothlessGear/node-gcm</a></li>
</ol>

<h2 id="연구원-소개">연구원 소개</h2>

<ul>
<li>작성자 : <a href="http://about.me/saltfactory">송성광</a> 개발 연구원</li>
<li>블로그 : <a href="http://blog.saltfactory.net">http://blog.saltfactory.net</a></li>
<li>이메일 : <a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
<li>트위터 : <a href="https://twitter.com/saltfactory">@saltfactory</a></li>
<li>페이스북 : <a href="https://facebook.com/salthub">https://facebook.com/salthub</a></li>
<li>연구소 : <a href="http://www.hibrain.net">하이브레인넷</a> 부설연구소</li>
<li>연구실 : <a href="http://dblab.changwon.ac.kr">창원대학교 데이터베이스 연구실</a></li>
</ul>

  </article>

  
  
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    
      var disqus_shortname = 'saltfactorynet';
    
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <!-- <h2 class="footer-heading">saltfactory's series</h2> -->

    <div class="footer-col-1 column">
      <ul>
        <li><a href="http://saltfactory.net">www.saltfactory.net</a></li>
        <li><a href="http://blog.saltfactory.net">blog.saltfactory.net</a></li>
        <li><a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/saltfactory">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
  <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
  c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
  c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
  c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
  C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
  c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
  c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
  c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
  c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
</svg>

            </span>
            <span class="username">saltfactory</span>
          </a>
        </li>

        <li>
          <a href="https://twitter.com/saltfactory">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
  <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
  c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
  c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
  C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
  c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
  c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
</svg>

            </span>
            <span class="username">saltfactory</span>
          </a>
        </li>

        <li>
          <a href="https://facebook.com/saltfactory">
            <span class="icon facebook">
          		<svg class="facebook-icon-svg" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <path d="M0.112290344,30 C0.112290344,13.4314567 13.3426506,0 29.663129,0 C45.9836073,0 59.2139676,13.4314567 59.2139676,30 C59.2139676,46.5685433 45.9836073,60 29.663129,60 C13.3426506,60 0.112290344,46.5685433 0.112290344,30 Z M0.112290344,30" fill="#C2C2C2" sketch:type="MSShapeGroup"></path>
	<path d="M32.1341457,46.3196729 L32.1341457,29.9980891 L36.5657565,29.9980891 L37.1530406,24.3735809 L32.1341457,24.3735809 L32.141675,21.5584604 C32.141675,20.091502 32.2787707,19.3054722 34.351206,19.3054722 L37.1216686,19.3054722 L37.1216686,13.6803271 L32.6894304,13.6803271 C27.3655995,13.6803271 25.491749,16.4088187 25.491749,20.9972835 L25.491749,24.3742179 L22.1732173,24.3742179 L22.1732173,29.998726 L25.491749,29.998726 L25.491749,46.3196729 L32.1341457,46.3196729 Z M32.1341457,46.3196729" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
</svg>
		
        	</span>
        	<span class="username">salthub</span>
			</a>
        </li>

      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text"></p>
    </div>

  </div>

</footer>


	<script src="/series/assets/javascripts/jekyll-img-converter.js"></script>
    </body>
</html>
