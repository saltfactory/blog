<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Tistory 오픈 API 인증 모듈 passport-tistory 소개</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">
    <link rel="canonical" href="/series/passport-tistory/create-passport-tistory.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/series/assets/css/main.css">
    <!-- <link rel='stylesheet' type='text/css' href='/assets/css/main.css' /> -->

    
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/series/">saltfactory's series</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="page-link" href="/">saltfactory.net</a>
        <a class="page-link" href="/guestbook">Guestbook</a>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Tistory 오픈 API 인증 모듈 passport-tistory 소개</h1>
    <p class="meta">Jul 16, 2014</p>
  </header>

  <article class="post-content">
  <h2 id="서론">서론</h2>

<p>passport는 Node.js의 인증을 처리하기 위한 인기있는 모듈중에 하나이다. passport를 사용하면 Open API를 위한 복잡한 OAuth 인증을 따로 구현하지 않고 쉽게 어플리케이션에 API를 위한 인증로직을 포함시켜 사용할 수 있다. 이 포스트에서는 Tistory의 Open API를 사용하기 위해 Tistory 인증모듈을 passport를 사용하여 구현한 사례를 소개한다.</p>

<!--more-->

<h2 id="passport-tistory">passport-tistory</h2>

<blockquote>
<p><em>passport-tistory 는 Node.js 어플리케이션을 만들거나 티스토리 오픈 API 인증을 처리하는데 쉽고 편리하게 도와주는 인증처리 모듈이다.</em></p>
</blockquote>

<p><a href="https://github.com/saltfactory/passport-tistory">passport-tistory</a>는 npm을 사용하여 설치할 수 있다.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">npm install passport-tistory
</code></pre></div>
<p>Tistory는 오픈 API를 제공하고 있다. 오픈 API를 사용하면 다양한 어플리케이션을 만들거사 서비스를 만들수 있기 때문에 개발자들은 오픈 API를 사용하고 싶어 한다. 하지만 오픈 API를 사용할때, 가정 먼저 걸림돌이 되는 것이 바로 인증 문제인다. 여러 사람이 사용하는 오픈 API는 보안문제 때문에 password 인증으로 할 수 없기 때문에 이젠 오픈 API의 인증에는 거의 표준이 되어 버리는 OAuth 인증을 사용하고 있다. Tistory 또한 OAuth 인증을 사용하는데 OAuth2.0 을 사용하고 있다.</p>

<h2 id="oauth-2.0">OAuth 2.0</h2>

<p>오픈 API 의 인증에 표준화인 OAuth2.0을 Tistory에서도 인증처리를 하기 위해서 사용하고 있다. <a href="http://oauth.net/2/">OAuth 2.0</a>의 스펙은 <a href="http://tools.ietf.org/html/rfc6749">rfc6794</a>에 정의가 되어 있다. 한국어로 쉽게 설명이 되어 있는 곳이 있는데 <a href="https://twitter.com/tebica">@tebica</a> 님께서 작성하신 <a href="http://earlybird.kr/1584">OAUTH 2.0 - OPEN API 인증을 위한 만능 도구상자</a> 글을 읽어보면 OAuth 인증에 관한 전반적인 이해와 2.0에 대해서 쉽게 이해할 수 있다.</p>

<h2 id="passport">Passport</h2>

<p>Node.js의 모듈은 편리한 모듈가 참 많이 있다. 그 중에서 인증을 처리하기 위해서 가장 유명한 모듈인  <a href="http://passportjs.org">Passport</a> 를 사용하면 local 인증부터 OAuth 인증까지 쉽게 구현할 수 있다. 더구나 passport는 140개 이상의 인증 strategy가 만들어져 있다. 여기에는 국내 개발자분들이 만들어 놓은 strategy도 있다.</p>

<p><a href="https://twitter.com/Outsideris">@Outsideris</a> 님께서 만드신 <a href="https://github.com/outsideris/passport-me2day">passport-me2day</a>는 me2day 서비스의 인증을 처리하기 위한 strategy 이고 <a href="http://twitter.com/rotoshine">@rotoshine</a>님께서 만드신 <a href="https://github.com/rotoshine/passport-kakao">passport-kakao</a> 는 kaka 서비스의 인증을 처리하기 위한 strategy 이다.</p>

<h1 id="passport-tistory-strategy-구현">passport-tistory Strategy 구현</h1>

<p>Passport는 모듈을 상속받아서 상세 구현을 할 수 있게 설계가 되어 있다. passport- 로 시작하는 모듈은 모두 Passport의 Strategy를 상속받아서 만들어진 것들이다.</p>

<h2 id="passport-oauth2">passport-oauth2</h2>

<p>OAuth2.0 인증을 처리하기 위해서 이미 passport-oauth2 strategy가 만들어져 있다. 그래서 OAuth2.0 인증을 처리하기 위해서 기본적으로 passport-oauth2를 상속받아서 서비스에 맞게 수정해주면 된다.</p>

<h2 id="package.json">package.json</h2>

<p>우리는 passport와 passport-oauth2 모듈이 필요하기 때문에 package.json을 다음과 같이 생성하였다.</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">...</span> <span class="err">생략</span> <span class="err">...</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;passport&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;passport-oauth2&quot;</span><span class="p">:</span><span class="s2">&quot;~1.1.2&quot;</span>
  <span class="p">},</span>
  <span class="err">...</span> <span class="err">생략</span> <span class="err">...</span>
<span class="p">}</span>
</code></pre></div>
<p>전체 소스는 github에서 <a href="https://github.com/saltfactory/passport-tistory/blob/master/package.json">package.json</a> 확인할 수 있다.</p>

<h2 id="strategy.js-구현">strategy.js  구현</h2>

<h3 id="passort-oauth2-상속">passort-oauth2 상속</h3>

<p><a href="https://github.com/saltfactory/passport-tistory/blob/master/lib/passport-tistory/strategy.js">strategy.js</a>는 passport-oauth2를 상속받아서 구현할 수 있기 때문에 TistoryStrategy를 OAuth2Strategy를 상속받아서 만들었다. strategy를 상속받는 코드는 다음과 같이 <code>util.inherits()</code>를 사용하면 된다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
<span class="nx">OAuth2Strategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-oauth2&#39;</span><span class="p">),</span>
<span class="nx">profile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./profile&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * TistoryStrategy 생성자</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">TistoryStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">){</span>

<span class="p">}</span>
  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="c1">// passport-oauth2 상속</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">TistoryStrategy</span><span class="p">,</span> <span class="nx">OAuth2Strategy</span><span class="p">);</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="cm">/**</span>
<span class="cm"> * Expose `TistoryStrategy`.</span>
<span class="cm"> */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">TistoryStrategy</span><span class="p">;</span>  
</code></pre></div>
<h3 id="passport-aouth2의-인증처리-함수-호출">passport-aouth2의 인증처리 함수 호출</h3>

<p>passport-oauth2 모듈이 이미 OAuth 2.0 인증 프로세스를 구현해두었기 때문에 우리는 OAuth2Strategy의 인증처리하는 함수를 바로 호출하면 된다. 이것은 다음과 같이 <code>OAuth2Strategy.call()</code>을 호출하면 된다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
<span class="nx">OAuth2Strategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-oauth2&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * TistoryStrategy 생성자</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">TistoryStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">){</span>
  <span class="nx">OAuth2Strategy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">);</span>
<span class="p">}</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="c1">// passport-oauth2 상속</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">TistoryStrategy</span><span class="p">,</span> <span class="nx">OAuth2Strategy</span><span class="p">);</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="cm">/**</span>
<span class="cm"> * Expose `TistoryStrategy`.</span>
<span class="cm"> */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">TistoryStrategy</span><span class="p">;</span>
</code></pre></div>
<h3 id="options-재정의">options 재정의</h3>

<p>passport-aouth2를 상속받아서 인증처리하는 함수를 사용할 수 있지만 인증처리를 위한 URL은 다시 정의를 해야한다.</p>

<p>OAuth 2.0에는 인증처리를 위해서 크게 3가지 URL이 필요하다.
1. authorizationURL - 인증요청을 하는 URL
2. tokenURL - 최초 사용자 인증 후 어플리케이션에서 사용할 access_token을 요청하는 URL
3. callbackURL - OAuth 2.0의 인증 처리후 요청할 callback URL 이다.</p>

<p>우리는 Tistory의 인증 API에 정의한 URL을 그대로 사용할 수 있게 했다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
<span class="nx">OAuth2Strategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-oauth2&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * TistoryStrategy 생성자</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">TistoryStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">oauthHost</span> <span class="o">=</span> <span class="s1">&#39;https://www.tistory.com&#39;</span><span class="p">;</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">authorizationURL</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">authorizationURL</span> <span class="o">||</span> <span class="nx">oauthHost</span> <span class="o">+</span> <span class="s1">&#39;/oauth/authorize&#39;</span><span class="p">;</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">tokenURL</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">tokenURL</span> <span class="o">||</span>  <span class="nx">oauthHost</span> <span class="o">+</span> <span class="s1">&#39;/oauth/access_token&#39;</span><span class="p">;</span>

  <span class="nx">options</span><span class="p">.</span><span class="nx">customHeaders</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">customHeaders</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">customHeaders</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">customHeaders</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">userAgent</span> <span class="o">||</span> <span class="s1">&#39;passport-tistory&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 인증처리 호출</span>
  <span class="nx">OAuth2Strategy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">);</span>
<span class="p">}</span>
  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="c1">// passport-oauth2 상속</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">TistoryStrategy</span><span class="p">,</span> <span class="nx">OAuth2Strategy</span><span class="p">);</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>
<span class="cm">/**</span>
<span class="cm"> * Expose `TistoryStrategy`.</span>
<span class="cm"> */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">TistoryStrategy</span><span class="p">;</span>
</code></pre></div>
<h1 id="oauth2의-함수-override">OAuth2의 함수 Override</h1>

<p>보통은 passport-oauth2 을 상속받아서 OAuth 2.0 인증을 처리하기 위해서는 위의 코드로 되지만
Tistory의 인증은 access_token을 획득하기 위해서 access_key를 얻을 수 있는 페이지로 한번더 redirect를 한다는 것을 알게 되었다.
passport-oauth2는 oauth 모듈을 사용하는데 oauth2의 인증처리 루틴을 모두 http 모듈의 request를 사용해서 POST로 전송하는 것을 알게되었다.
이렇게 oauth 모듈의 post 처리와 Tistory의 redirect는 access_token을 획득할 때 301 moved permanently explained 에러를 발생하는 것을 확인했다.
소스 코드를 분석한 결과 passport-oauth에서 사용하고 있는 oauth2의 <code>_chooseHttpLibrary</code>와 <code>getOAuthAccessToken</code> 함수를 override 하였다.</p>

<h3 id="follow-redirects와-querystring-모듈-설치">follow-redirects와 querystring 모듈 설치</h3>

<p>우리는 redirect 문제를 해결하기 위해서 <code>follow-redirects</code> 모듈을 설치할 것이고 redirect following은 GET으로만 사용할 수 있기 때문에 POST의 body로 요청한 것을 GET의 query string으로 변경하기 위해서 <code>querystring</code> 모듈을 설치할 것이다.
이 두가지를 설치하기 위해서 <code>package.json</code> 파일을 다음과 같이 수정한다.</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">...</span> <span class="err">생략</span> <span class="err">...</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;passport&quot;</span><span class="p">:</span> <span class="s2">&quot;~0.2.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;passport-oauth2&quot;</span><span class="p">:</span><span class="s2">&quot;~1.1.2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;follow-redirects&quot;</span><span class="p">:</span><span class="s2">&quot;~0.0.3&quot;</span><span class="p">,</span>
    <span class="nt">&quot;querystring&quot;</span><span class="p">:</span><span class="s2">&quot;~0.2.0&quot;</span>
  <span class="p">},</span>
  <span class="err">...</span> <span class="err">생략</span> <span class="err">...</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="oauth2._choosehttplibrary()-함수-재정의">oauth2._chooseHttpLibrary() 함수 재정의</h3>

<p><code>oauth2._chooseHttpLibrary()</code>함수는 http나 https 요청을 처리하기 위해서 http 라이브리를 정의하는 함수이 이다.
우리가 지금 가지고 있는 문제는 redirect 문제 인데 이 문제를 해결하기 위해서 우리는 기존의 <code>require(&#39;http&#39;)</code>를 사용하지 않고 redirect 페이지를 follow할 수 있는 follow-redirect 모듈로 교체할 것이다.</p>

<h3 id="oauth2.getoauthaccesstoken()-함수-재정의">oauth2.getOAuthAccessToken() 함수 재정의</h3>

<p>passport-oauth2에서 access_token을 획득하기 위해서 사용하고 있는 <code>oauth2.getOAuthAccessToken()</code> 함수는 POST로 동작하고 있다. 하지만 http.request로 요청했을 때 page redirect된 것을 follow하기 위해서는 POST를 사용하면 안된다.
즉, page redirect following은 GET으로만 가능하다. 그래서 우리는 <code>oauth2.getOAuthAccessToken()</code> 함수 안에서 POST의 body를 만드는 부분은 querystring으로 변경해서 url querystring을 만들어서 GET으로 request를 요청하는 것으로 교체하였다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
  <span class="nx">profile</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./profile&#39;</span><span class="p">),</span>
  <span class="nx">querystring</span><span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">),</span>
  <span class="nx">OAuth2Strategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-oauth2&#39;</span><span class="p">),</span>
  <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;follow-redirects&#39;</span><span class="p">).</span><span class="nx">http</span><span class="p">,</span>
  <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;follow-redirects&#39;</span><span class="p">).</span><span class="nx">https</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">TistoryStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_oauth2</span><span class="p">.</span><span class="nx">_chooseHttpLibrary</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">parsedUrl</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">http_library</span><span class="o">=</span> <span class="nx">https</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">parsedUrl</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">!=</span> <span class="s2">&quot;https:&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">http_library</span><span class="o">=</span> <span class="nx">http</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">http_library</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_oauth2</span><span class="p">.</span><span class="nx">getOAuthAccessToken</span><span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">params</span><span class="o">=</span> <span class="nx">params</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">params</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_clientId</span><span class="p">;</span>
    <span class="nx">params</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_clientSecret</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">codeParam</span> <span class="o">=</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">grant_type</span> <span class="o">===</span> <span class="s1">&#39;refresh_token&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;refresh_token&#39;</span> <span class="o">:</span> <span class="s1">&#39;code&#39;</span><span class="p">;</span>
    <span class="nx">params</span><span class="p">[</span><span class="nx">codeParam</span><span class="p">]</span><span class="o">=</span> <span class="nx">code</span><span class="p">;</span>


    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getAccessTokenUrl</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">params</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">_request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="nx">error</span> <span class="p">)</span>  <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">results</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="c1">// As of http://tools.ietf.org/html/draft-ietf-oauth-v2-07</span>
          <span class="c1">// responses should be in JSON</span>
          <span class="nx">results</span><span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// .... However both Facebook + Github currently use rev05 of the spec</span>
          <span class="c1">// and neither seem to specify a content-type correctly in their response headers :(</span>
          <span class="c1">// clients of these services will suffer a *minor* performance cost of the exception</span>
          <span class="c1">// being thrown</span>
          <span class="nx">results</span><span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">access_token</span><span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">refresh_token</span><span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">];</span>
        <span class="k">delete</span> <span class="nx">results</span><span class="p">[</span><span class="s2">&quot;refresh_token&quot;</span><span class="p">];</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">access_token</span><span class="p">,</span> <span class="nx">refresh_token</span><span class="p">,</span> <span class="nx">results</span><span class="p">);</span> <span class="c1">// callback results =-=</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h1 id="passport-tistory-profile-구현">passport-tistory Profile 구현</h1>

<p>passport는 인증처리 후 user의 정보를 가져올 수 있는 루틴이 포함되어 있는데 바로 <code>userProfile</code>을 사용하는 것이다.
<a href="https://github.com/saltfactory/passport-tistory/blob/master/lib/passport-tistory/profile.js">profile.js</a>는 쉽게 생각하면 일종의 User의 정보를 담아두는 Model 이다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/**</span>
<span class="cm"> * Parse profile.</span>
<span class="cm"> *</span>
<span class="cm"> * @param {Object|String} json</span>
<span class="cm"> * @return {Object}</span>
<span class="cm"> * @api private</span>
<span class="cm"> */</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">profile</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">profile</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">profile</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">profile</span><span class="p">.</span><span class="nx">provider</span> <span class="o">=</span> <span class="s1">&#39;tistory&#39;</span><span class="p">;</span>



  <span class="k">return</span> <span class="nx">profile</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>profile.js를 생성하면 strategy.js에 require하여 profile을 바로 사용할 수 있다.
strategy의 인증처리가 끝나면 인증후 획득한 access_key를 가지고 자동적으로 userProfile을 수행하여 API로 얻어온 user 정보를 저장하게 된다.
보통은 User 값을 가져오는 API를 동작하지만 Tistory API에서는 User 정보를 가져오는 API가 없다. 그래서 블로그 정보를 얻어오는 URL을 userProfile에 사용하게 했다.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
<span class="nx">OAuth2Strategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-oauth2&#39;</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * TistoryStrategy 생성자</span>
<span class="cm"> * @constructor</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">TistoryStrategy</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">){</span>
  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>
  <span class="c1">// 인증처리 호출</span>
  <span class="nx">OAuth2Strategy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">verify</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;tistory&#39;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_userProfileURL</span> <span class="o">=</span> <span class="s1">&#39;https://www.tistory.com/apis/blog/info?output=json&#39;</span><span class="p">;</span>
<span class="p">}</span>
  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>

<span class="c1">// passport-oauth2 상속</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">TistoryStrategy</span><span class="p">,</span> <span class="nx">OAuth2Strategy</span><span class="p">);</span>

  <span class="p">...</span> <span class="err">생략</span> <span class="p">...</span>
<span class="cm">/**</span>
<span class="cm"> * Tistory 블로그 정보를 얻는다.</span>
<span class="cm"> * 사용자 정보를 성공적으로 조회하면 아래의 object가 done 콜백함수 호출과 함꼐 넘어간다.</span>
<span class="cm"> */</span>
<span class="nx">TistoryStrategy</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">userProfile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">_oauth2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_userProfileURL</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="k">new</span> <span class="nx">InternalOAuthError</span><span class="p">(</span><span class="s1">&#39;failed to fetch user profile&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">));</span> <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>

      <span class="nx">profile</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tistory</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tistory</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">userId</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tistory</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">tistory</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tistory</span><span class="p">.</span><span class="nx">tistory</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">item</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tistory</span><span class="p">.</span><span class="nx">item</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">body</span><span class="p">;</span>
      <span class="nx">profile</span><span class="p">.</span><span class="nx">_json</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>

      <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">profile</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">done</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Expose `TistoryStrategy`.</span>
<span class="cm"> */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">TistoryStrategy</span><span class="p">;</span>
</code></pre></div>
<p>우리는 Tistory의 OAuth 2.0 인증을 처리하기 위해서 TistoryStrategy와 Profile을 만들었다.
그럼 이렇게 만든 passport-tistory 인증모듈을 어디에 어떻게 사용할 수 있는지는 다음 포스팅에서 알아보기로 하겠다.
직접 express로 웹 프로젝트를 만들고 passport-tistory를 사용해서 인증을 완료한 뒤에 Tistory의 오픈 API를 사용하는 예제를 포스팅할 예정이다.</p>

<h2 id="결론">결론</h2>

<p>난생 처음으로 conributor가 되었다. 항상 Node.js 개발을 하면서 모듈을 가져와서 사용하기만 했는데 언젠가 한번 내가 직접 등록하고 싶다고 생각했는데 Tistory 오픈 API를 사용할 일이 생겨서 이번 기회에 npm 으로 배포할 수 있게 되었다.
아직 0.1.0 버전으로 병아리 패키지이다. 하지만 처음으로 conributor가 된 것에 스스로 감동하고 있다. 그리고 앞으로는 개인적으로 만들어서 사용한 모듈을 될 수 있는한 오류 없이 문서화해서 배포할 수 있게 구현할 예정이다.</p>

<p>passport-tistory 를 구현하는데 처음에는 생각보다 쉽지 않았다. 우선 oauth2.js의 동작하는 방법을 알아야했고, Tistory에서 access_token을 획득하는데 있어서 <strong>301 moved permanently explained</strong> 에러를 해결하는데 꽤 많은 시간을 보냈다.
이 시간동안에 module과 module.exports 개념을 알게 되었고, 뿐만 아니라 <em>http redirect following</em> 이라는 개념도 알게 되었다.</p>

<blockquote>
<p><em>배우는 것보다 가르치는 것이 더 많이 배우는 기회가 된다.</em></p>
</blockquote>

<p>라고 가르쳐주신 교수님의 말씀이 생각난다. 연구원으로 살면서 앞으로도 더 많은 모듈을 만들어서 배포할 수 있는 contributor가 되려고 노력하고 싶다.</p>

<h2 id="참고자료">참고자료</h2>

<ul>
<li><a href="https://github.com/jaredhanson/passport">https://github.com/jaredhanson/passport</a></li>
<li><a href="http://blog.outsider.ne.kr/829">http://blog.outsider.ne.kr/829</a></li>
<li><a href="https://github.com/outsideris/passport-me2day">https://github.com/outsideris/passport-me2day</a></li>
<li><a href="https://github.com/rotoshine/passport-kakao">https://github.com/rotoshine/passport-kakao</a></li>
<li><a href="https://github.com/olalonde/follow-redirects">https://github.com/olalonde/follow-redirects</a></li>
<li><a href="https://github.com/Gozala/querystring">https://github.com/Gozala/querystring</a></li>
<li><a href="https://github.com/visionmedia/express">https://github.com/visionmedia/express</a></li>
</ul>

<h2 id="연구원-소개">연구원 소개</h2>

<ul>
<li>작성자 : <a href="http://about.me/saltfactory">송성광</a> 개발 연구원</li>
<li>블로그 : <a href="http://blog.saltfactory.net">http://blog.saltfactory.net</a></li>
<li>이메일 : <a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
<li>트위터 : <a href="https://twitter.com/saltfactory">@saltfactory</a></li>
<li>페이스북 : <a href="https://facebook.com/salthub">https://facebook.com/salthub</a></li>
<li>연구소 : <a href="http://www.hibrain.net">하이브레인넷</a> 부설연구소</li>
<li>연구실 : <a href="http://dblab.changwon.ac.kr">창원대학교 데이터베이스 연구실</a></li>
</ul>

  </article>

  
  
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    
      var disqus_shortname = 'saltfactorynet';
    
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <!-- <h2 class="footer-heading">saltfactory's series</h2> -->

    <div class="footer-col-1 column">
      <ul>
        <li><a href="http://saltfactory.net">www.saltfactory.net</a></li>
        <li><a href="http://blog.saltfactory.net">blog.saltfactory.net</a></li>
        <li><a href="mailto:saltfactory@gmail.com">saltfactory@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/saltfactory">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
  <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
  c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
  c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
  c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
  C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
  c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
  c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
  c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
  c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
</svg>

            </span>
            <span class="username">saltfactory</span>
          </a>
        </li>

        <li>
          <a href="https://twitter.com/saltfactory">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
  <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
  c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
  c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
  C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
  c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
  c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
</svg>

            </span>
            <span class="username">saltfactory</span>
          </a>
        </li>

        <li>
          <a href="https://facebook.com/saltfactory">
            <span class="icon facebook">
          		<svg class="facebook-icon-svg" viewBox="0 0 60 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <path d="M0.112290344,30 C0.112290344,13.4314567 13.3426506,0 29.663129,0 C45.9836073,0 59.2139676,13.4314567 59.2139676,30 C59.2139676,46.5685433 45.9836073,60 29.663129,60 C13.3426506,60 0.112290344,46.5685433 0.112290344,30 Z M0.112290344,30" fill="#C2C2C2" sketch:type="MSShapeGroup"></path>
	<path d="M32.1341457,46.3196729 L32.1341457,29.9980891 L36.5657565,29.9980891 L37.1530406,24.3735809 L32.1341457,24.3735809 L32.141675,21.5584604 C32.141675,20.091502 32.2787707,19.3054722 34.351206,19.3054722 L37.1216686,19.3054722 L37.1216686,13.6803271 L32.6894304,13.6803271 C27.3655995,13.6803271 25.491749,16.4088187 25.491749,20.9972835 L25.491749,24.3742179 L22.1732173,24.3742179 L22.1732173,29.998726 L25.491749,29.998726 L25.491749,46.3196729 L32.1341457,46.3196729 Z M32.1341457,46.3196729" id="Path" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>
</svg>
		
        	</span>
        	<span class="username">salthub</span>
			</a>
        </li>

      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text"></p>
    </div>

  </div>

</footer>


	<script src="/series/assets/javascripts/jekyll-img-converter.js"></script>
    </body>
</html>
